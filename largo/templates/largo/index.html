<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <style type="text/css">
      html {
        height: 100%;
      }

      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      #data {
        background-color: lightgrey;
        border-bottom: 1px solid grey;
        padding: 5px;
        position: absolute;
        width: 100%;
        z-index: 1;
      }

      #map-canvas {
        height: 100%;
      }
    </style>

    <script type="text/javascript"
	    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBx_W_m2aw-5IOL_EThLyYC2M3AK-u1q_k&sensor=false">
    </script>

  </head>

  <body>
    <div id="data">{{ time_sec }}</div>

    <div id="map-canvas" />

    <script>
      var getData = function(timeSec, processData) {
        var req = new XMLHttpRequest();

        req.onreadystatechange = function() {
          if (this.readyState != 4) {
            return;
          }
          if (this.status == 200) {
            processData(this.responseText);
          }
        };
        req.open(
            "GET",
            "{% url 'views.get_cars' %}?time_sec=" + timeSec,
            true);
        req.send();
      };

      var initialize = function() {
        var mapOptions = {
          center: new google.maps.LatLng(47.609722, -122.333056),
          zoom: 12,
          disableDefaultUI: true,
        };
        var map = new google.maps.Map(
            document.getElementById("map-canvas"), mapOptions);
        getData({{ time_sec }}, function(data) {
           cars = JSON.parse(data);
           console.log(cars);
           for (var i = 0; i < cars.length; i++) {
             var marker = new google.maps.Marker({
               // TODO: In the data set, the longitude is being stored
               // as the latitude and the latitude and longitude. Until
               // that bug is fixed, we'll have to swap them here. :(
               position: new google.maps.LatLng(cars[i].lon, cars[i].lat),
               map: map,
               title: cars[i].name,
             });
           }
        });
      };
      google.maps.event.addDomListener(window, 'load', initialize);

    </script>
  </body>
</html>
