<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <style type="text/css">
      html {
        height: 100%;
      }

      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      #data {
        background-color: lightgrey;
        border-bottom: 1px solid grey;
        padding: 5px;
        position: absolute;
        width: 100%;
        z-index: 1;
      }

      #map-canvas {
        height: 100%;
      }
    </style>

    <script type="text/javascript"
	    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBx_W_m2aw-5IOL_EThLyYC2M3AK-u1q_k&sensor=false">
    </script>

  </head>

  <body>
    <div id="data">
      <a href="#" id="-1m">-1m</a>
      <span id="current-time">{{ time_sec }}</span>
      <a href="#" id="+1m">+1m</a>
    </div>

    <div id="map-canvas" />

    <script>
      var currentTimeSec = {{ time_sec }};

      var getData = function(timeSec, processData) {
        var req = new XMLHttpRequest();

        req.onreadystatechange = function() {
          if (this.readyState != 4) {
            return;
          }
          if (this.status == 200) {
            processData(this.responseText);
          }
        };
        req.open(
            "GET",
            "{% url 'views.get_cars' %}?time_sec=" + timeSec,
            true);
        req.send();
      };

      var mapOptions = {
        center: new google.maps.LatLng(47.609722, -122.333056),
        zoom: 12,
        disableDefaultUI: true,
      };
      var map = new google.maps.Map(
          document.getElementById("map-canvas"), mapOptions);
      var markers = [];
      var addMarkers = function(data) {
        // TODO: Instead of removing all markers and adding new ones,
        // we should only remove the markers that need to be removed.
        var cars = JSON.parse(data);
        for (var i = 0; i < markers.length; i++) {
          markers[i].setMap(null);
        }
        markers = [];

        for (var i = 0; i < cars.length; i++) {
          var marker = new google.maps.Marker({
            // TODO: In the data set, the longitude is being stored
            // as the latitude and the latitude and longitude. Until
            // that bug is fixed, we'll have to swap them here. :(
            position: new google.maps.LatLng(cars[i].lon, cars[i].lat),
            map: map,
            title: cars[i].name,
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              fillColor: 'red',
              fillOpacity: 1,
              scale: 5,
              strokeWeight: 0,
            },
          });
          markers.push(marker);
        }
      };

      getData(currentTimeSec, addMarkers);

      var currentTimeSpan = document.getElementById("current-time");

      // TODO: Remove the redundancy between the -1m and +1m logic.
      var minus1m = document.getElementById("-1m");
      minus1m.onclick = function() {
        currentTimeSec = currentTimeSec - 60;
        getData(currentTimeSec, addMarkers);
        currentTimeSpan.innerHTML = currentTimeSec;
        return false;
      };

      var plus1m = document.getElementById("+1m");
      plus1m.onclick = function() {
        currentTimeSec = currentTimeSec + 60;
        getData(currentTimeSec, addMarkers);
        currentTimeSpan.innerHTML = currentTimeSec;
        return false;
      };
    </script>
  </body>
</html>
